---
lab:
  title: エージェント プールを構成してパイプライン スタイルを把握する
  module: 'Module 02: Implement CI with Azure Pipelines and GitHub Actions'
---

# エージェント プールを構成してパイプライン スタイルを把握する

## ラボの要件

- このラボには、**Microsoft Edge** または [Azure DevOps 対応ブラウザー](https://docs.microsoft.com/azure/devops/server/compatibility)が必要です。

- **Azure DevOps 組織を設定する:** このラボで使用できる Azure DevOps 組織がまだない場合は、[組織またはプロジェクト コレクションの作成](https://docs.microsoft.com/azure/devops/organizations/accounts/create-organization)に関するページの手順に従って作成してください。

- [Git for Windows ダウンロード ページ](https://gitforwindows.org/)。 このラボでは前提条件の一部としてインストールされます。

- [Visual Studio Code](https://code.visualstudio.com/)。 このラボでは前提条件の一部としてインストールされます。

## ラボの概要

YAML ベースのパイプラインを使用すると、CI/CD をコードとして完全に実装できます。パイプライン定義は、Azure DevOps プロジェクトの一部であるコードと同じリポジトリにあります。 YAML ベースのパイプラインは、プルリクエスト、コードレビュー、履歴、分岐、テンプレートなど、従来のパイプラインの一部である幅広い機能をサポートします。

パイプライン スタイルの選択に関係なく、Azure Pipelines を使用してコードをビルドしたりソリューションをデプロイしたりするには、エージェントが必要です。 エージェントは、一度に 1 つのジョブを実行するコンピューティング リソースをホストします。 ジョブは、エージェントのホスト マシンで直接実行することも、コンテナーで実行することもできます。 管理されている Microsoft がホストするエージェントを使用してジョブを実行するか、自分で設定および管理するセルフホステッド エージェントを実装するかを選択できます。

このラボでは、YAML パイプラインでセルフホステッド エージェントを実装して使用する方法について学習します。

## 目標

このラボを完了すると、次のことができるようになります。

- YAML ベースのパイプラインを実装する
- セルフホステッド エージェントを実装する

## 推定時間:30 分

## 手順

### 演習 0: ラボの前提条件を構成する (完了している場合はスキップしてください)

この演習では、ラボの前提条件を設定します。これは、[eShopOnWeb](https://github.com/MicrosoftLearning/eShopOnWeb) に基づくリポジトリを含む新しい Azure DevOps プロジェクトで構成されます。

#### タスク 1: (完了している場合はスキップしてください) チーム プロジェクトを作成して構成する

このタスクでは、複数のラボで使用される **eShopOnWeb** Azure DevOps プロジェクトを作成します。

1. ラボ コンピューターのブラウザー ウィンドウで、Azure DevOps 組織を開きます。 **[新しいプロジェクト]** をクリックします。 プロジェクトに「**eShopOnWeb**」という名前を付け、他のフィールドは既定値のままにします。 **[作成]** をクリックします。

#### タスク 2: (完了している場合はスキップしてください) eShopOnWeb Git リポジトリをインポートする

このタスクでは、複数のラボで使用される eShopOnWeb Git リポジトリをインポートします。

1. ラボ コンピューターのブラウザー ウィンドウで、Azure DevOps 組織と、前に作成した **eShopOnWeb** プロジェクトを開きます。 **[リポジトリ]、[ファイル]**、**[リポジトリをインポートする]** の順にクリックします。 **インポート** を選択します。 **[Git リポジトリをインポートする]** ウィンドウで、URL <https://github.com/MicrosoftLearning/eShopOnWeb.git> を貼り付けて、 **[インポート]** をクリックします。

1. リポジトリは次のように編成されています。
    - **.ado** フォルダーには、Azure DevOps の YAML パイプラインが含まれています。
    - **.devcontainer** フォルダーには、コンテナーを使って開発するためのセットアップが含まれています (VS Code でローカルに、または GitHub Codespaces で)。
    - **infra** フォルダーには、一部のラボ シナリオで使用される Bicep および ARM のコードとしてのインフラストラクチャ テンプレートが含まれています。
    - **.github** フォルダーには、YAML GitHub ワークフローの定義が含まれています。
    - **src** フォルダーには、ラボ シナリオで使用される .NET 8 Web サイトが含まれています。

#### タスク 3: (完了している場合はスキップしてください) メイン ブランチを既定のブランチとして設定する

1. **[リポジトリ]、[ブランチ]** の順に移動します。
1. **main** ブランチをポイントし、列の右側に表示される省略記号をクリックします。
1. **[既定のブランチとして設定]** をクリックします。

### 演習 1: エージェントを作成し、エージェント プールを構成する

この演習では、Azure 仮想マシン (VM) を作成し、それを使ってエージェントを作成し、エージェント プールを構成します。

#### タスク 1:Azure VM を作成して接続する

1. ブラウザーで Azure Portal (`https://portal.azure.com`) を開きます。 プロンプトが表示されたら、Azure サブスクリプションの所有者ロールを持つアカウントを使ってサインインします。

1. **[リソース、サービス、ドキュメントの検索 (G+/)]** ボックスに「**`Virtual Machines`**」と入力し、ドロップダウン リストからそれを選びます。

1. **[作成]** ボタンを選択します。

1. **[構成が事前設定された Azure 仮想マシン]** を選びます。

    ![構成が事前設定された仮想マシンの作成のスクリーンショット。](images/create-virtual-machine-preset.png)

1. ワークロード環境として **[Dev/Test]** を選び、ワークロードの種類として **[汎用]** を選びます。

1. **[VM の作成を続行する]** ボタンを選び、**[基本]** タブで次の操作を実行し、**[管理]** を選びます。

   | 設定 | アクション |
   | -- | -- |
   | **[サブスクリプション]** ドロップダウン リスト | Azure サブスクリプションを選択します。 |
   | **[リソース グループ]** セクション | **rg-eshoponweb-agentpool** という名前の新しいリソース グループを作成します。 |
   | **[仮想マシン名]** テキスト ボックス | 任意の名前 (例: **`eshoponweb-vm`**) を入力します。 |
   | **[リージョン]** ドロップダウン リスト | 最も近い [azure](https://azure.microsoft.com/explore/global-infrastructure/geographies) リージョンを選択できます。 たとえば、"eastus"、"eastasia"、"westus" などです。 |
   | **[可用性のオプション]** ドロップダウン リスト | **[インフラストラクチャ冗長は必要ありません]** を選択します。 |
   | **[セキュリティの種類]** ドロップダウン リスト | **[トラステッド起動の仮想マシン]** オプションを選びます。 |
   | **[イメージ]** ドロップダウン リスト | **Windows Server 2022 Datacenter: Azure Edition - x64 Gen2** イメージを選びます。 |
   | **[サイズ]** ドロップダウン リスト | テスト目的の場合は最も安価な **[Standard]** サイズを選びます。 |
   | **[ユーザー名]** テキスト ボックス | 任意のユーザー名を入力します |
   | **[パスワード]** テキスト ボックス | 任意のパスワードを入力します |
   | **[パブリック受信ポート]** セクション | **[選択したポートを許可する]** を選択します。 |
   | **[受信ポートを選択]** ドロップダウン リスト | **[RDP (3389)]** を選択します。 |

1. **[管理]** タブの **[ID]** セクションで、**[システム割り当てマネージド ID の有効化]** チェックボックスをオンにし、**[確認および作成]** を選びます。

1. **[確認および作成]** タブで、 **[作成]** を選択します。

   > **注**:プロビジョニング プロセスが完了するまで待ちます。 これには 2 分ほどかかります。

1. Azure portal で、新しく作成された Azure VM の構成が表示されるページに移動します。

1. Azure VM ページで、**[接続]** を選択し、ドロップダウン メニューで、**[接続]** を選択し、次に **[RDP ファイルのダウンロード]** を選択します。

1. ダウンロードした RDP ファイルを使用して、Azure VM で実行されているオペレーティング システムへのリモート デスクトップ セッションを確立します。

#### タスク 2:エージェント プールを作成する

1. Azure VM へのリモート デスクトップ セッションで、Microsoft Edge Web ブラウザーを起動します。

1. Web ブラウザーで Azure DevOps ポータル (`https://aex.dev.azure.com`) に移動し、サインインして組織にアクセスします。

   > **注**: 初めて Azure DevOps ポータルにアクセスする場合は、プロファイルの作成が必要になる場合があります。

1. **eShopOnWeb** プロジェクトを開き、左側の下部メニューから **[プロジェクトの設定]** を選びます。

1. **[パイプライン] > [エージェント プール]** で、**[プールの追加]** を選びます。

1. プールのタイプとして **[セルフホステッド]** を選びます。

1. エージェント プールの名前 (**eShopOnWebSelfPool** など) を指定し、オプションの説明を追加します。

1. **[すべてのパイプラインにアクセス権を付与する]** オプションをオフにします。

   ![セルフホステッド タイプのエージェント プールの追加オプションを示すスクリーンショット。](images/create-new-agent-pool-self-hosted-agent.png)

   > **注**: 運用環境では、すべてのパイプラインにアクセス許可を付与することは推奨されません。 このラボでは、パイプラインの構成を簡略化するためにのみ使用されます。

1. **[作成]** を選び、エージェント プールを作成します。

#### タスク 3:エージェントのインストール ファイルをダウンロードして展開する

1. Azure DevOps ポータルで、新しく作成したエージェント プールを選び、**[エージェント]** タブを選びます。

1. **[新しいエージェント]** を選び、新しいポップアップ ウィンドウの **[エージェントのダウンロード]** から **[ダウンロード]** を選びます。

   > **注**: インストール手順に従ってエージェントをインストールします。

1. PowerShell セッションを開始し、次のコマンドを実行して **agent** というフォルダーを作成します。

   ```powershell
   mkdir agent ; cd agent        
   ```

   > **注**: エージェントをインストールするフォルダー (C:\agent など) を開いていることを確認します。

1. 次のコマンドを実行し、ダウンロードしたエージェント インストーラー ファイルの内容を抽出します。

   ```powershell
   Add-Type -AssemblyName System.IO.Compression.FileSystem ; [System.IO.Compression.ZipFile]::ExtractToDirectory("$HOME\Downloads\vsts-agent-win-x64-3.245.0.zip", "$PWD")
   ```

   > **注**: エージェントを別の場所にダウンロードした場合 (またはダウンロードしたバージョンが異なる場合) は、上記のコマンドを適宜調整してください。

#### タスク 4:PAT トークンを作成する

> **注**: エージェントを構成する前に、PAT トークンを作成する必要があります (既存のものがない場合)。 PAT トークンを作成するには、以下の手順を実行します。

1. Azure VM へのリモート デスクトップ セッション内で、別のブラウザー画面を開き、`https://aex.dev.azure.com` の Azure DevOps ポータルに移動して、組織とプロジェクトにアクセスします。

1. 右側の上部メニュー (ユーザーのアバター アイコンのすぐ左) から **[ユーザー設定]** を選びます。

1. **[個人用アクセス トークン]** メニュー項目を選びます。

   ![[個人用アクセス トークン] メニューを示すスクリーンショット。](images/personal-access-token-menu.png)

1. **[新しいトークン]** を選びます。

1. トークンの名前を指定します (**eShopOnWebToken** など)。

1. トークンを使う Azure DevOps 組織を選びます。

1. トークンの有効期限を設定します (エージェントの構成にのみ使用されます)。

1. カスタム定義されたスコープを選択します。

1. すべてのスコープを表示する場合に選択します。

1. **エージェント プール (読み取りおよび管理)** スコープを選択します。

1. **[作成]** を選び、トークンを作成します。

1. トークンの値をコピーし、安全な場所に保存します (再度表示することはできません。 再生成できるのはトークンだけです)。

   ![個人用アクセス トークンの構成を示すスクリーンショット。](images/personal-access-token-configuration.png)

   > [!IMPORTANT]
   > 最小限の特権オプションである **[エージェント プール (読み取り、管理)]** は、エージェントの構成にのみ使います。 また、それがトークンの唯一の目的である場合は、トークンには必ず最短の有効期限を設定してください。 エージェントを再度構成する必要がある場合は、同じ特権を持つ別のトークンを作成できます。

#### タスク 5:エージェントの構成

1. Azure VM へのリモート デスクトップ セッション内で、PowerShell ウィンドウに戻ります。 必要に応じて、現在のディレクトリを、この演習で先ほどエージェント インストール ファイルを抽出したディレクトリに変更します。

1. エージェントを無人で実行するように構成するには、次のコマンドを呼び出します。

   ```powershell
   .\config.cmd
   ```

   > **注**: エージェントを対話形式で実行する場合は、代わりに `.\run.cmd` を使用します。

1. エージェントを構成するには、プロンプトが表示されたら次のアクションを実行します。

   - Azure DevOps 組織の URL (**サーバー URL**) を `https://aex.dev.azure.com`{お客様の組織名} 形式で入力します。
   - 既定の認証の種類 (**`PAT`**) を受け入れます。
   - 前の手順で作成した PAT トークンの値を入力します。
   - この演習で先ほど作成したエージェント プール名 **`eShopOnWebSelfPool`** を入力します。
   - エージェント名 **`eShopOnWebSelfAgent`** を入力します。
   - 既定のエージェント作業フォルダー (_work) をそのまま使います。
   - 「**Y**」と入力して、エージェントがサービスとして実行されるように構成します。
   - 「**Y**」と入力して、エージェント サービスの SERVICE_SID_TYPE_UNRESTRICTED を有効にします。
   - 「**`NT AUTHORITY\SYSTEM`**」と入力して、サービスのセキュリティ コンテキストを設定します。

   > [!IMPORTANT]
   > 一般にサービス セキュリティ コンテキストを構成するときは、最小限の特権の原則に従うようにします。

   - 既定のオプション (**N**) のままにして、構成の完了後すぐにサービスを開始できるようにします。

   ![エージェントの構成を示すスクリーンショット。](images/agent-configuration.png)

   > **注**: エージェントの構成プロセスが完了するまでに数分かかります。 完了すると、エージェントがサービスとして実行されていることを示すメッセージが表示されます。

   > [!IMPORTANT] エージェントが実行されていないことを示すエラー メッセージが表示された場合は、サービスを手動で開始することが必要な場合があります。 これを行うには、Windows のコントロール パネルで**サービス** アプレットを開き、**Azure DevOps Agent (eShopOnWebSelfAgent)** という名前のサービスを見つけて起動します。

   > [!IMPORTANT] エージェントの起動に失敗した場合は、エージェントの作業ディレクトリに別のフォルダーを選択することが必要な場合があります。 これを行うには、エージェント構成スクリプトを再実行し、別のフォルダーを選択します。

1. Azure DevOps ポータルを表示している Web ブラウザーに切り替え、エージェント プールに移動し、**[エージェント]** タブをクリックして、エージェントの状態を確認します。一覧に新しいエージェントが表示されます。

   ![エージェントの状態を示すスクリーンショット。](images/agent-status.png)

   > **注**: Windows エージェントの詳細については、「[セルフホステッド Windows エージェント](https://learn.microsoft.com/azure/devops/pipelines/agents/windows-agent)」をご覧ください。

   > [!IMPORTANT]
   > エージェントが Azure DevOps パイプラインから Azure リソースをビルドしてデプロイできるようにするには (今後のラボで手順を実行します)、エージェントをホストしている Azure VM のオペレーティング システム内に Azure CLI をインストールする必要があります。

1. Web ブラウザーを起動し、[[Windows に Azure CLI をインストールする]](https://learn.microsoft.com/cli/azure/install-azure-cli-windows?tabs=azure-cli#install-or-update) ページに移動します。

1. Azure CLI をダウンロードしてインストールします。

1. (省略可能) 必要に応じて、次の PowerShell コマンドを実行して Azure CLI をインストールします。

   ```powershell
   $ProgressPreference = 'SilentlyContinue'; Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile .\AzureCLI.msi; Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'; Remove-Item .\AzureCLI.msi
   ```

   > **注**: 別のバージョンの Azure CLI を使用している場合は、それに応じて上記のコマンドの調整が必要になる場合があります。

1. Web ブラウザーで、`https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-8.0.403-windows-x64-installer` の Microsoft .NET 8.0 SDK インストーラー ページに移動します。

   > [!IMPORTANT]
   > エージェントをホストしている Azure VM に .NET 8.0 SDK (またはそれ以降) をインストールする必要があります。 これは、今後のラボで eShopOnWeb アプリケーションをビルドするために必要です。 アプリケーションのビルドに必要なその他のツールまたは SDK も、Azure VM にインストールする必要があります。

1. Microsoft .NET 8.0 SDK をダウンロードしてインストールします。

### 演習 2: YAML ベースの Azure Pipelines を作成する

この演習では、YAML ベースのテンプレートを使用して、アプリケーション ライフサイクル ビルド パイプラインを作成します。

#### タスク 1:Azure DevOps YAML パイプラインを作成する

このタスクでは、**eShopOnWeb** プロジェクトの YAML ベースのパイプラインを作成します。

1. **eShopOnWeb** プロジェクトが開いた状態で Azure DevOps ポータルを表示している Web ブラウザーから、左側の垂直ナビゲーション ウィンドウで、**[パイプライン]** をクリックします。
1. **[パイプラインの作成]** ボタンをクリックします。まだ他のパイプラインを作成していない場合は、**[新しいパイプライン]** をクリックして新しいパイプラインを作成します。

1. **[コードはどこにありますか?]** ペインで **[Azure Repos Git]** をクリックします。
1. **[リポジトリの選択]** ペインで **eShopOnWeb** をクリックします。
1. **[パイプラインの構成]** ペインで、 **[既存の Azure Pipelines YAML ファイル]** を選択します。
1. **[既存の YAML ファイルの選択]** で、[ブランチ] では **[メイン]** を、[パス] では **[/.ado/eshoponweb-ci-pr.yml]** を選択します。
1. **[続行]** をクリックします。
1. **[パイプライン YAML の確認]** ペインで、サンプル パイプラインを確認します。 これは、次の処理を行う、かなり簡単な .NET アプリケーション ビルド パイプラインです。

   - 1 つのステージ: Build
   - 1 つのジョブ: Build
   - ビルド ジョブ内の 4 つのタスク:
   - Dotnet Restore
   - Dotnet Build
   - Dotnet Test
   - Dotnet Publish

1. **[パイプライン YAML の確認]** ペインで、 **[実行]** ボタンの横にある下向きのキャレット記号をクリックして、 **[保存]** をクリックします。

    > **注**: ここではパイプライン定義を作成しているだけであり、それを実行はしません。 最初に Azure DevOps エージェント プールを設定し、後の演習でパイプラインを実行します。

#### タスク 2: セルフホステッド エージェント プールを使用して YAML パイプラインを更新する

1. Azure DevOps ポータルで、**eShopOnWeb** プロジェクトに移動し、左側のメニューから **[パイプライン]** を選択します。
1. 前のタスクで作成したパイプラインの **[編集]** ボタンをクリックします。
1. **[eShopOnWeb]** 編集ペインの既存の YAML ベースのパイプラインで、ターゲット エージェント プールを指定している **vmlmage: ubuntu-latest** という 13 行目の行を削除し、新しく作成したセルフホステッド エージェント プールを指定します。

    ```yaml
    pool: 
      name: eShopOnWebSelfPool
      demands: Agent.Name -equals eShopOnWebSelfAgent
    ```

    > **警告**:コピーと貼り付けを行うときは、上記と同じインデントになるように注意してください。

    ![YAML プールの構文を示すスクリーンショット。](images/eshoponweb-ci-pr-agent-pool.png)

1. **[eShopOnWeb]** 編集ペインで、ペインの右上隅にある **[検証して保存]** をクリックします。 **[保存]** をクリックします。
1. **[eShopOnWeb]** 編集ペインの右上隅にある **[パイプラインを実行]** をクリックします。

    > **注**: パイプラインは、前の演習で作成したセルフホステッド エージェント プールで実行されます。
1. パイプライン実行を開き、正常に完了するまでジョブを監視します。

    > **注**: アクセス許可プロンプトが表示された場合は、**[許可]** をクリックしてパイプラインの実行を許可します。

1. パイプライン実行が完了したら、出力を確認し、パイプラインが正常に実行されたことを確認します。

## 確認

このラボでは、YAML パイプラインでセルフホステッド エージェントを実装して使用する方法について学習しました。
