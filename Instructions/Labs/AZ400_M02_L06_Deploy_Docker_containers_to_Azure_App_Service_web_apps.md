---
lab:
  title: Docker コンテナーを Azure App Service Web アプリにデプロイする
  module: 'Module 02: Implement CI with Azure Pipelines and GitHub Actions'
---

# Docker コンテナーを Azure App Service Web アプリにデプロイする

## ラボの要件

- このラボには、**Microsoft Edge** または [Azure DevOps 対応ブラウザー](https://learn.microsoft.com/azure/devops/server/compatibility)が必要です。

- **Azure DevOps 組織を設定する:** このラボで使用できる Azure DevOps 組織がまだない場合は、[組織またはプロジェクト コレクションの作成](https://learn.microsoft.com/azure/devops/organizations/accounts/create-organization)に関するページの手順に従って作成してください。

- 既存の Azure サブスクリプションを識別するか、新しいものを作成します。

- Azure サブスクリプションで共同作成者または所有者のロールを持つ Microsoft アカウントまたは Microsoft Entra アカウントを持っていることを確認します。 詳細については、[「Azure portal を使用して Azure ロールの割り当てを一覧表示する」](https://learn.microsoft.com/azure/role-based-access-control/role-assignments-list-portal)および[「Azure Active Directory で管理者ロールを表示して割当てる」](https://learn.microsoft.com/azure/active-directory/roles/manage-roles-portal)を参照してください。

## ラボの概要

このラボでは、Azure DevOps CI/CD パイプラインを使用してカスタム Docker イメージを構築し、それを Azure Container Registry にプッシュして、コンテナーとして Azure App Service にデプロイする方法を学習します。

## 目標

このラボを完了すると、次のことができるようになります。

- Microsoft がホストする Linux エージェントを使用して、カスタム Docker イメージを構築する
- Azure Container Registry にイメージをプッシュする
- Azure DevOps を使用して、Docker イメージをコンテナーとして Azure App Service にデプロイする

## 推定時間:20 分

## 手順

### 演習 0: ラボの前提条件を構成する (完了している場合はスキップしてください)

この演習では、ラボの前提条件を設定します。これは、[eShopOnWeb](https://github.com/MicrosoftLearning/eShopOnWeb) に基づくリポジトリを含む新しい Azure DevOps プロジェクトで構成されます。

#### タスク 1: (完了している場合はスキップしてください) チーム プロジェクトを作成して構成する

このタスクでは、複数のラボで使用される **eShopOnWeb** Azure DevOps プロジェクトを作成します。

1. ラボ コンピューターのブラウザー ウィンドウで、Azure DevOps 組織を開きます。 **[新しいプロジェクト]** をクリックします。 プロジェクトに **eShopOnWeb** という名前を付け、 **[作業項目プロセス]** ドロップダウンで **[スクラム]** を選びます。 **[作成]** をクリックします。

#### タスク 2: (完了している場合はスキップしてください) eShopOnWeb Git リポジトリをインポートする

このタスクでは、複数のラボで使用される eShopOnWeb Git リポジトリをインポートします。

1. ラボ コンピューターのブラウザー ウィンドウで、Azure DevOps 組織と、前に作成した **eShopOnWeb** プロジェクトを開きます。 **[リポジトリ]、[ファイル]**、**[インポート]** の順にクリックします。 **[Git リポジトリをインポートする]** ウィンドウで、URL <https://github.com/MicrosoftLearning/eShopOnWeb.git> を貼り付けて、 **[インポート]** をクリックします。

1. リポジトリは次のように編成されています。
    - **.ado** フォルダーには、Azure DevOps の YAML パイプラインが含まれています。
    - **.devcontainer** フォルダーには、コンテナーを使って開発するためのセットアップが含まれています (VS Code でローカルに、または GitHub Codespaces で)。
    - **infra** フォルダーには、一部のラボ シナリオで使用される Bicep および ARM のコードとしてのインフラストラクチャ テンプレートが含まれています。
    - **.github** フォルダーには、YAML GitHub ワークフローの定義が含まれています。
    - **src** フォルダーには、ラボ シナリオで使用される .NET 8 Web サイトが含まれています。

#### タスク 3: (完了している場合はスキップしてください) メイン ブランチを既定のブランチとして設定する

1. **[リポジトリ]、[ブランチ]** の順に移動します。
1. **main** ブランチをポイントし、列の右側に表示される省略記号をクリックします。
1. **[既定のブランチとして設定]** をクリックします。

### 演習 1: CI パイプラインをインポートして実行する

この演習では、Azure サブスクリプションとのサービス接続を構成し、CI パイプラインをインポートして実行します。

#### タスク 1: CI パイプラインをインポートして実行する

1. **[パイプライン]、[パイプライン]** の順に移動します
1. **[新しいパイプライン]** ボタン (または、以前に作成したパイプラインがない場合は、**[パイプラインの作成]**) をクリックします
1. **[Azure Repos Git (YAML)]** を選びます
1. **eShopOnWeb** リポジトリを選びます
1. **[既存の Azure Pipelines YAML ファイル]** を選択します。
1. **メイン** ブランチと **/.ado/eshoponweb-ci-docker.yml** ファイルを選択し、**[続行]** をクリックします
1. YAML パイプライン定義で、次をカスタマイズします。
   - **YOUR-SUBSCRIPTION-ID** を、お使いの Azure サブスクリプション ID に置き換えます。
   - **resourceGroup** を、サービス接続の作成時に使用するリソース グループ名 (**AZ400-RG1** など) に置き換えます。

1. パイプライン定義を確認します。 CI の定義は以下のタスクで構成されます。
    - **リソース**: 以下のタスクで使われるリポジトリ ファイルをダウンロードします。
    - **AzureResourceManagerTemplateDeployment**: bicep テンプレートを使用して Azure Container Registry をデプロイします。
    - **PowerShell**: 前のタスクの出力から **ACR ログイン サーバー**の値を取得し、新しいパラメーター **acrLoginServer** を作成します
    - [**Docker**](https://learn.microsoft.com/azure/devops/pipelines/tasks/reference/docker-v0?view=azure-pipelines) **- Build**: Docker イメージをビルドし、2 つのタグを作成します (最新と現在の BuildID)
    - **Docker - Push**: Azure Container Registry にイメージをプッシュします

1. **[保存および実行]** をクリックします。

1. パイプラインの実行を開きます。 "この実行を続行して Build に進む前に、リソースにアクセスするためのアクセス許可がこのパイプラインに必要です" という警告メッセージが表示された場合は、**[表示]**、**[許可]**、さらにもう一度 **[許可]** をクリックします。 これにより、パイプラインが Azure サブスクリプションにアクセスできるようになります。

    > **注**: デプロイが完了するまでに数分かかる場合があります。

1. パイプラインには、プロジェクト名に基づく名前が付けられます。 パイプラインを識別しやすくするために、**名前を変更**しましょう。 **[パイプライン] - [パイプライン]** に移動し、先ほど作成したパイプラインをクリックします。 省略記号と **[名前の変更または移動]** オプションをクリックします。 **eshoponweb-ci-docker** という名前を付け、 **[保存]** をクリックします。

1. [**Azure portal**](https://portal.azure.com) に移動し、先ほど作成したリソース グループ (**AZ400-RG1** という名前であるはずです) で Azure Container Registry を検索します。 左側の **[サービス]** の下にある **[リポジトリ]** をクリックし、リポジトリ **eshoponweb/web** が作成されていることを確認します。 リポジトリ リンクをクリックすると、2 つのタグ (そのうちの 1 つが **最新**) が表示されます。これらはプッシュされたイメージです。 これが表示されない場合は、パイプラインの状態を調べます。

### 演習 2: CD パイプラインをインポートして実行する

この演習では、Azure サブスクリプションとのサービス接続を構成した後、CD パイプラインをインポートして実行します。

#### タスク 1: CD パイプラインをインポートして実行する

このタスクでは、CD パイプラインをインポートして実行します。

1. **[パイプライン]、[パイプライン]** の順に移動します
1. **[新しいパイプライン]** ボタンをクリックします
1. **[Azure Repos Git (YAML)]** を選びます
1. **eShopOnWeb** リポジトリを選びます
1. **[既存の Azure Pipelines の YAML ファイル]** を選択します
1. **メイン** ブランチと **/.ado/eshoponweb-cd-webapp-docker.yml** ファイルを選択し、**[続行]** をクリックします
1. YAML パイプライン定義で、次をカスタマイズします。
   - **YOUR-SUBSCRIPTION-ID** を、お使いの Azure サブスクリプション ID に置き換えます。
   - **resourceGroup** を、サービス接続の作成時に使用するリソース グループ名 (**AZ400-RG1** など) に置き換えます。
   - **location** を、リソースがデプロイされる Azure リージョンに置き換えます。

1. パイプライン定義を確認します。 CD の定義は以下のタスクで構成されます。
    - **リソース**: 以下のタスクで使われるリポジトリ ファイルをダウンロードします。
    - **AzureResourceManagerTemplateDeployment**: bicep テンプレートを使用して Azure App Service をデプロイします。
    - **AzureResourceManagerTemplateDeployment**: Bicep を使用してロールの割り当てを追加します

1. **[保存および実行]** をクリックします。

1. パイプラインの実行を開きます。 "この実行を続行して Deploy に進む前に、リソースにアクセスするためのアクセス許可がこのパイプラインに必要です" という警告メッセージが表示された場合は、**[表示]**、**[許可]**、さらにもう一度 **[許可]** をクリックします。 これにより、パイプラインが Azure サブスクリプションにアクセスできるようになります。

    > **重要**: 構成時にパイプラインを承認しないと、実行中にアクセス許可エラーが発生します。 一般的なエラー メッセージには、"このパイプラインにはリソースにアクセスするためのアクセス許可が必要です" や "アクセス許可が不十分なためパイプラインの実行に失敗しました" などがあります。 これを解決するには、パイプラインの実行に移動し、アクセス許可要求の横にある **[表示]** をクリックし、**[アクセス許可]** をクリックして、Azure サブスクリプションとリソースに必要なアクセス権を付与します。

    > **注**: デプロイが完了するまでに数分かかる場合があります。

    > [!IMPORTANT]
    > "TF402455: このブランチに対するプッシュは許可されていません。このブランチを更新するには pull request を使用する必要があります" というエラー メッセージが表示された場合は、前のラボで有効にした [最小数のレビュー担当者が必要です] というブランチ保護ルールをオフにする必要があります。

1. パイプラインには、プロジェクト名に基づく名前が付けられます。 パイプラインを識別しやすくするために、**名前を変更**しましょう。 **[パイプライン]、[パイプライン]** の順に移動し、先ほど作成したパイプラインにマウス ポインターを合わせます。 省略記号と **[名前の変更または移動]** オプションをクリックします。 **eshoponweb-cd-webapp-docker** という名前を付け、 **[保存]** をクリックします。

    > **注 1**: **/infra/webapp-docker.bicep** テンプレートを使用すると、アプリ サービス プラン、システム割り当てマネージド ID が有効な Web アプリが作成され、前にプッシュされた Docker イメージ **${acr.properties.loginServer}/eshoponweb/web:latest** が作成されます。

    > **注 2**:**/infra/webapp-to-acr-roleassignment.bicep** テンプレートを使用すると、Docker イメージを取得できるように、AcrPull ロールを使用して Web アプリの新しいロールの割り当てが作成されます。 これは最初のテンプレートで実行される可能性がありますが、ロールの割り当てが反映されるまでには時間がかかることがあるため、両方のタスクを個別に実行することをお勧めします。

#### タスク 2: ソリューションをテストする

1. Azure Portal で、最近作成したリソース グループに移動すると、3 つのリソース (Ap Service、App Service プラン、Container Registry) が表示されます。

1. App Service に移動し、 **[参照]** をクリックすると、Web サイトに移動します。

1. eShopOnWeb アプリケーションが正常に実行されていることを確認します。 確認したら、ラボは正常に終了します。

> [!IMPORTANT]
> 不要な料金が発生しないように、Azure portal で作成されたリソースを必ず削除してください。

## 確認

このラボでは、Azure DevOps CI/CD パイプラインを使用してカスタム Docker イメージを作成し、それを Azure Container Registry にプッシュして、コンテナーとして Azure App Service にデプロイする方法を学習しました。
